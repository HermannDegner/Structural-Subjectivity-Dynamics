# Nano-SSD：能動NPC向けミニマム実装仕様（v1）

> 目的：SSDの核心（整合／跳躍）を**軽量に蒸留**し、能動NPCがリアルタイムで回せる最小コアを定義する。

---

## 1. コア概念（NPCが保持する最小状態）
- **p**：意味圧（外界・相手・目標からの要求強度）。スカラーでもベクトルでも可。
- **κ（カッパ）**：整合慣性（過去の成功経路の通りやすさ）。学習で増え、未使用で減衰。
- **θ（シータ）**：臨界（跳躍トリガ閾値）。|p| ≥ θ で跳躍モードへ。
- **β（ベータ）**：探索温度（ランダム接続率）。熱や硬直度に応じて自動調整。
- **j**：整合流（反応強度）。最小式：`j = (G0 + g·κ) · p + ε`。
- **E**：未処理圧（“熱”）。整合が追いつかない差分の蓄積。
- **F**：疲労（可逆）。高いとθが下がりやすい／行動品質が落ちる。
- **G = (S, E_edges, w)**：小規模ディレクテッドグラフ（ノード=戦術/知識、エッジ重み w）。

> 推奨規模：ノード10〜30、エッジ30〜100。全処理 O(|E_edges|)。

---

## 2. 1ティック更新（擬似コード）
```text
# 入力（観測→意味圧p）
p ← sense(world, goals, opponent)

# 整合ステップ（決定論）
j ← (G0 + g*κ) * p + noise(ε)
reward, fatigue_delta ← evaluate(j, world)
κ ← κ + η*(reward) - λ*(unused)            # 学習・忘却
F ← clamp(F + fatigue_delta - rest(world), 0, Fmax)

# 熱の更新（整合不能の計上）
E ← E + α*max(|p| - |j|, 0) - β_E*E

# 跳躍判定（確率）
Θ ← Θ0 + a1*mean(κ) - a2*F
h ← h0 * exp((E - Θ)/γ)
if rand() < 1 - exp(-h*dt):
    # 制約付きランダム接続（構造依存＋ノイズ）
    C ← candidate_nodes(G, context)
    T ← T0 + c1*E - c2*entropy(policy_prev)
    k ~ softmax((sim(current,k) + N(0,σ^2)) / T) over k∈C
    add_or_boost_edge(G, current, k, Δw)
    κ[current,k] ← κ[current,k] + Δκ_plus
    # 硬直ほぐし（上位q%の過飽和経路を微減）
    for e in top_q_percent_edges_by_flow(G): κ[e] ← κ[e] - ε_relax
    # 放熱
    E ← c0 * E

# 行動選択（軽量）
action ← argmax_a Q(a) where Q ≈ immediate_utility(a) + b*κ_path(a)
execute(action)
```

---

## 3. 簡易方程式と意味
- **整合流**：`j = (G0 + g·κ)·p + ε`  …… 既存経路での反応。κ↑で省エネ化・安定化。
- **熱**：`Ė = α·[|p| - |j|]_+ - β_E·E` …… 追いつかない分が溜まる。休息や成功で減る。
- **跳躍率**：`h = h0 · exp((E - Θ)/γ)` …… 閾値超えで非連続接続（確率ジャンプ）。
- **閾値**：`Θ = Θ0 + a1·κ̄ - a2·F` …… 慣性が高いほど跳びにくいが、疲労で下がる。
- **温度**：`T = T0 + c1·E - c2·H(π)` …… 熱・硬直度で探索温度を自動制御。

---

## 4. 候補選択：制約付きランダム
- **候補集合 C**：状況に適合するノード（距離・タグ・役割）。
- **確率分布**：`π(k) ∝ exp((sim + noise)/T)`。
- **sim**：構造依存の近さ（コサイン類似度/タグ一致/地理的近接）。
- **noise**：N(0,σ²)。
- **探索混合**：ε-greedyでごく低確率の完全ランダム接続も混ぜる。

---

## 5. ふるまい接続（BT/GOAP統合）
- **BT**：Selector( AlignNode | LeapNode ) を **θゲート**で切替。
  - AlignNode：既存戦術の評価・実行・κ更新。
  - LeapNode：1本だけ新戦術/連想を追加→直後は低コスト試行。
- **GOAP**：Plannerの評価関数に `κ_path` と `疲労F` を加算。高κのプランを優先しつつ、E↑で探索幅を拡張。
- **Blackboard**：`p, κ̄, Θ, E, F, T, last_jump_ts` を共有。

---

## 6. チューニング・レシピ
- **硬直して単調**：`T0↑, σ↑, ε_relax↑, c1↑, ε_greedy↑`。
- **暴走して雑**：`T0↓, σ↓, ρ↑(失敗ペナルティ), c2↑(エントロピー制御), h0↓`。
- **過跳躍**：`γ↑(滑らかに), Θ0↑, a1↑, クールダウン追加`。
- **考えすぎで動かない**：`g↑, G0↑, λ↑(忘却促進), β_E↑(熱の自然減衰)`。

---

## 7. パラメータの目安（ゲーム向け）
| 記号 | 既定 | 範囲 | 意味 |
|---|---:|---:|---|
| G0 | 0.5 | 0.1–1.0 | 基本通りやすさ |
| g  | 0.7 | 0.2–1.5 | κの影響係数 |
| η  | 0.3 | 0.1–0.5 | 学習率（成功時Δκ） |
| λ  | 0.02| 0.005–0.05 | 忘却（未使用減衰） |
| α  | 0.6 | 0.2–1.0 | 熱の蓄積係数 |
| β_E| 0.15| 0.05–0.3 | 熱の自然減衰 |
| Θ0 | 1.0 | 0.5–2.0 | 基本閾値 |
| a1 | 0.5 | 0–1.0 | κ̄の閾値補正 |
| a2 | 0.4 | 0–1.0 | 疲労の閾値補正 |
| h0 | 0.2 | 0.05–0.5 | 跳躍のベース強度 |
| γ  | 0.8 | 0.4–1.5 | 発火曲線の鋭さ |
| T0 | 0.3 | 0.1–0.7 | 探索温度の下限 |
| c1 | 0.5 | 0.1–1.0 | 熱→温度の利得 |
| c2 | 0.6 | 0.2–1.2 | 硬直（低エントロピー）補正 |
| σ  | 0.2 | 0.05–0.5 | ノイズ幅 |

> 数値は目安。ゲーム速度やフレームレートに合わせてスケーリング。

---

## 8. 例：巡回ガード（5戦術／20エッジ）
- ノード：{巡回, 追跡, 呼集, 威嚇, 待機}
- ルーチン：通常は `巡回→威嚇→追跡` のκが太く、|p|（侵入者圧）が高まるとE↑。
- 閾値超えで跳躍：`呼集` への新規接続が出現→局所的に強化→以後は侵入者密度が高い場面で優先。
- 退屈（長時間イベント無し）：軽い跳躍で `待機→巡回（遠回りコース）` の枝を形成し、単調さを回避。

---

## 9. 計測（テレメトリ）
- 整合効率 `|J|/|p|`、熱E、温度T、政策エントロピーH(π)、跳躍頻度/間隔、創造歩留まり（新接続の生存率）。
- KPIをHUD/コンソールに簡易表示するとデバッグが劇的に楽。

---

## 10. 安全装置（ゲームバランス）
- **クールダウン**：連続跳躍の最短間隔を設定（例：≥ 3s）。
- **範囲制限**：候補集合Cを“世界観に適合するタグ”で絞る。
- **冷静性ノブ**：`β_E↑, c2↑` で無駄跳躍を抑え、必要跳躍のみ残す。

---

## 11. 実装ヒント（Unity/Unreal）
- **Unity**：ScriptableObjectでパラメータ束ね、BT(Behavior Designer/Apex等)のDecoratorにθ判定。
- **Unreal**：Blackboardに `p, κ̄, Θ, E, F, T` を置き、BTのServiceで更新。EQ Sクエリのスコアにκを加味。

---

## 12. 拡張オプション（必要になったら）
- 多体相互作用（Hawkes過程）で集団カスケード。
- ランドウ自由エネルギー表示で相転移を可視化。
- 言語/NPC関係学習：ノードを台詞/態度ラベルに拡張。

